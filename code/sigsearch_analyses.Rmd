---
title: "sigsearch_GSE69556"
author: "Lizzy Ramsey"
date: "4/7/2022"
output:
    html_document:
      toc: true
      toc_depth: 4
      toc_float: true

---


### Purpose  
This markdown follows differential expression analyses from deseq2_GSE134719.Rmd, deseq2_GSE149739.Rmd, and deseq2_GSE69556.Rmd. DEGs from these markdowns are used as input for signatureSearch. Results are annotated with Drug Repurposing Hub and onSides data.  
__Data Sets__
- '39 / Pre-Cystic P70: [GSE149739](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE149739)  
- '19 / Cystic P21: [GSE134719](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE134719)  
- '56 / Cystic P28: [GSE69556](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE69556)  

Load libraries  
```{r message=FALSE, warning = FALSE}
library(signatureSearch)
library(ggplot2)
library(ggalluvial)
#library(readr)
library(signatureSearch)
library(ExperimentHub); library(rhdf5)
library(here)
```

Pull LINCS data from Experiment Hub
```{r message=FALSE, warning = FALSE}
eh <- ExperimentHub()
cmap <- eh[["EH3223"]]; cmap_expr <- eh[["EH3224"]]
lincs <- eh[["EH3226"]]; lincs_expr <- eh[["EH3227"]]
h5ls(lincs)
db_path <- system.file("extdata", "sample_db.h5", package = "signatureSearch")

```

#### Custom functions  
__ssRun__: Wrapper for qsiq(), signature query, using up and down genes, and gess_lincs(), the 'lincs' signatureSearch method for gene expression signature search, sorting the results by WTCS and calculating Tau values, and then filtering for inversely related signatures and for kidney cell lines (HA1E and NKDBA) only  
```{r}
ssRun <- function(upgenes, downgenes, cells){
  q <- qSig(query = list(upset=as.character(upgenes), downset=as.character(downgenes)), gess_method="LINCS", refdb= lincs)
  gess <- gess_lincs(q, sortby="WTCS", tau=TRUE, workers=1)
  gess_res <- result(gess)
  gess_res <- dplyr::filter(gess_res, WTCS < 0) #filter for drugs with only inverse signatures
  if(cells == "kidney"){
    gess_kidney <- gess_res %>% dplyr::filter(cell == "HA1E" | cell == "NKDBA")
    return(gess_kidney)
  }
  else{
return(gess_res)
  }
}

```


### GSE149739 (precystic dataset)

Load in top up and down DEGs  
```{r}
#hom_39_UP <- read.csv(here("res", "deseq2_outputs", "p70_signature_UP.csv"))
#hom_39_DOWN <- read.csv(here("res", "deseq2_outputs", "p70_signature_DOWN.csv"))

hom_39_UP <- hom_degs_UP
hom_39_DOWN <- hom_degs_DOWN
```

Run signatureSearch, filter for kidney cell lines  
```{r}
gess_kidneycells_39 <- ssRun(upgenes = hom_39_UP$entrezgene_id, downgenes = hom_39_DOWN$entrezgene_id, cells = "kidney")
```

#### Visualize Top 20
```{r}
gess_res_vis(gess_kidneycells_39, drugs = unique(gess_kidneycells_39$pert)[1:20], col = "WTCS")
```


```{r }
write.csv(gess_kidneycells_39, file = here("res", "sigsearch_outputs", "gess_kidneycells_39_220819.csv"))
 
```

## GSE69556  

Load in top up and down DEGs  
```{r}
hom_56_UP <- read.csv(here("res", "deseq2_outputs", "p21_signature_UP.csv"))
hom_56_DOWN <- read.csv(here("res", "deseq2_outputs", "p21_signature_DOWN.csv"))

```

Run signatureSearch, filter for kidney cell lines  
```{r}
gess_kidneycells_56 <- ssRun(upgenes = as.character(hom_56_UP$entrezgene_id), downgenes = as.character(hom_56_DOWN$entrezgene_id), cells = "kidney")
```

#### Visualize Top 20
```{r}
gess_res_vis(gess_kidneycells_56, drugs = unique(gess_kidneycells_56$pert)[1:20], col = "WTCS")
```


Save gess and filtered gess result
```{r }
write.csv(gess_kidneycells_56, file = here("res", "sigsearch_outputs", "gess_kidneycells_56_220421.csv"))

```

## GSE134719  
Read in data  
```{r}
hom_19_UP <- read.csv(here("res", "deseq2_outputs", "p28_signature_UP.csv"))
hom_19_DOWN <- read.csv(here("res", "deseq2_outputs", "p28_signature_DOWN.csv"))

```

Run signatureSearch, filter for kidney cell lines  
```{r}
gess_kidneycells_19 <- ssRun(upgenes = as.character(hom_19_UP$entrezgene_id), downgenes = as.character(hom_19_DOWN$entrezgene_id), cells = "kidney")
```

#### Visualize Top 20
```{r}
gess_res_vis(gess_kidneycells_19, drugs = unique(gess_kidneycells_19$pert)[1:20], col = "WTCS")
```



Save gess and filtered gess result
```{r }
write.csv(gess_kidneycells_19, here("res", "sigsearch_outputs", "gess_kidneycells_19_220421.csv"))
```

## Compare datasets  
Dimensions  
```{r}
dim(gess_kidneycells_39)
dim(gess_kidneycells_56)
dim(gess_kidneycells_19)
```

Drug overlaps  
```{r}
overlap_39_56 <- dplyr::intersect(gess_kidneycells_39$pert, gess_kidneycells_56$pert) 

overlap_39_19 <- dplyr::intersect(gess_kidneycells_39$pert, gess_kidneycells_19$pert) 

overlap_56_19 <- dplyr::intersect(gess_kidneycells_56$pert, gess_kidneycells_19$pert) 

```

Number of drug overlaps  
```{r}
length(overlap_39_56)
length(overlap_39_19)
length(overlap_56_19)

```

### SignatureSearch Plots  
```{r}
bggenes <- read.csv(file = here("data", "background_genelist_genestoLINCSgenes.csv"), row.names = 1)
#KEGG enrichment based on hypergeometric test
kegg_39 <- enrichKEGG2(gene = as.character(c(hom_39_UP$entrezgene_id, hom_39_DOWN$entrezgene_id)), universe = bggenes$entrezgene_id)
moa_39 <- enrichMOA(gene = as.character(c(hom_39_UP$entrezgene_id, hom_39_DOWN$entrezgene_id)))
```

#### TSEA  
Target Set Enrichment Analysis. Uses target protein, cellular networks and pathways affected by the top ranking drugs  

'39 TSEA 
```{r warning = FALSE}
#target set enrichment analysis TSEA, looks at target proteins for the drugs and thedrug MOA's or protein family domains
tsea_GO_39 <- tsea_dup_hyperG(drugs = gess_kidneycells_39$pert[1:100], universe = "Default", type = "GO", ont="MF", pvalueCutoff=0.05, pAdjustMethod="BH")

tsea_KEGG_39 <- tsea_dup_hyperG(drugs = gess_kidneycells_39$pert[1:50], universe = "Default", type = "KEGG", pvalueCutoff=0.05, pAdjustMethod="BH")
```



'56 TSEA 
```{r}
tsea_GO_56 <- tsea_dup_hyperG(drugs = gess_kidneycells_56$pert[1:30], universe = "Default", type = "GO", ont="MF", pvalueCutoff=0.05, pAdjustMethod="BH")

tsea_KEGG_56 <- tsea_dup_hyperG(drugs = gess_kidneycells_56$pert[1:30], universe = "Default", type = "KEGG", pvalueCutoff=0.05, pAdjustMethod="BH")

#dtnetplot(drugs = drugs(tsea_GO_56), set = "GO:0004708", ont = "MF", desc="MAP kinase kinase activity")

```


Save TSEA tables
```{r }
write.csv(tsea_GO_56@result, file = here("res", "sigsearch_outputs", "tsea_go_56.csv"))

write.csv(tsea_KEGG_56@result, file = here("res", "sigsearch_outputs", "tsea_kegg_56.csv"))
```

'19 TSEA
```{r}
tsea_GO_19 <- tsea_dup_hyperG(drugs = gess_kidneycells_19$pert[1:30], universe = "Default", type = "GO", ont="MF", pvalueCutoff=0.05, pAdjustMethod="BH")

tsea_KEGG_19 <- tsea_dup_hyperG(drugs = gess_kidneycells_19$pert[1:30], universe = "Default", type = "KEGG", pvalueCutoff=0.05, pAdjustMethod="BH")

#dtnetplot(drugs = drugs(tsea_GO_19), set = "GO:0051117", ont = "MF", desc="ATPase binding")
```

```{r}
#dtnetplot(drugs = drugs(tsea_GO_19), set = "GO:0051117", ont = "MF", desc="ATPase binding")

```

Save TSEA tables
```{r }
write.csv(tsea_GO_19@result, file = here("res", "sigsearch_outputs", "tsea_go_19.csv"))

write.csv(tsea_KEGG_19@result, file = here("res", "sigsearch_outputs", "tsea_kegg_19.csv"))
```

#####Plots TSEA  

Read back in  
```{r}
tsea_GO_39 <- read.csv(file = here("res", "sigsearch_outputs", "tsea_go_39.csv"), row.names = 1)

```


##### DSEA
```{r}
dsea_39 <- dsea_hyperG(
  drugs = gess_kidneycells_39$pert[1:100],
  type = "GO",
  ont = "MF",
  pvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  qvalueCutoff = 0.2,
  minGSSize = 10,
  maxGSSize = 500
)
```


```{r}
write.csv(dsea_39@result, file = here("res", "sigsearch_outputs", "dsea_39.csv"))

dsea_39 <- read.csv(file = here("res", "sigsearch_outputs", "dsea_39.csv"))
```



#### DEGS-Targets TSEA
target set enrichment analysis for drugs with upregulated targets
```{r}
#cystictargets_ea <- tsea_dup_hyperG(drugs = unique(cystic_targets$pert), universe = "Default", type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")

tsea_p70 <- tsea_dup_hyperG(drugs = unique(targets_39$pert), universe = "Default", type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_p70 <- dplyr::filter(result(tsea_p70), p.adjust != 0.000000e+00)

tsea_21 <- tsea_dup_hyperG(drugs = unique(targets_in56$pert), universe = "Default", type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_21 <- dplyr::filter(result(tsea_21), p.adjust != 0.000000e+00)

tsea_28 <- tsea_dup_hyperG(drugs = unique(targets_in19$pert), universe = "Default", type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_28 <- dplyr::filter(result(tsea_28), p.adjust != 0.000000e+00)
```

drug set enrichment, precystic drugs whose targets match degs
```{r}
dsea_70 <- dsea_hyperG(drugs = unique(targets_39$pert),  type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_p70 <- dplyr::filter(result(tsea_p70), p.adjust != 0.000000e+00)

dsea_21 <- dsea_hyperG(drugs = unique(targets_in56$pert), type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_21 <- dplyr::filter(result(tsea_21), p.adjust != 0.000000e+00)

dsea_28 <- dsea_hyperG(drugs = unique(targets_in19$pert), type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_28 <- dplyr::filter(result(tsea_28), p.adjust != 0.000000e+00)


```

```{r}
table_list = list("P70" = result(dsea_70), 
                  "P21" = result(tsea_21), 
                  "P28" = result(tsea_28))

comp_fea_res(table_list, rank_stat="p.adjust", Nshow=20, size = )

```

drug set enrichment, ss results for each
```{r}
dsea_70 <- dsea_hyperG(drugs = unique(gess_kidneycells_39$pert)[1:10],  type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_p70 <- dplyr::filter(result(tsea_p70), p.adjust != 0.000000e+00)

dsea_21 <- dsea_hyperG(drugs = unique(gess_kidneycells_56$pert)[1:10], type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_21 <- dplyr::filter(result(tsea_21), p.adjust != 0.000000e+00)

dsea_28 <- dsea_hyperG(drugs = unique(gess_kidneycells_19$pert)[1:10], type = "GO", ont="BP", pvalueCutoff=0.05, pAdjustMethod="BH")
#tsea_28 <- dplyr::filter(result(tsea_28), p.adjust != 0.000000e+00)
```

```{r}
table_list = list("P70" = result(dsea_70), 
                  "P21" = result(tsea_21), 
                  "P28" = result(tsea_28))

comp_fea_res(table_list, rank_stat="p.adjust", Nshow=20)

```

Just pulling the cystic-overlapping, targets from precystic drugs that are represented as DEGs in both cystic data sets, and looking at their individual gprofiler results
```{r}
#pull those drugs from previous df
#cystic_overlap_drugs <- dplyr::filter(fda_approved_39, pert %in% unique(cystic_targets$pert))

#target_enrich <- function(ssres){
  #res <- vector(mode = "list", length = nrow(ssres))
#  res <- list()
#  for (i in nrow(ssres)) {
#    #m <- rep(i, nrow(ssres))
#    genelist <- stringr::str_split(ssres$t_gn_sym[i], "; ") 
#    fea <- gost(genelist, sources = c("KEGG", "WIKI", "GO:BP"))
#    #tmp <- [,]
#    #res[[i]] <- fea
#    #res <- append(res, list(fea))
#    res[[i]] <- fea
#  }
#  return(res)
#}

#test <- lapply(ssres, function(x)){
#  genelist <- stringr::str_split(x$t_gn_sym[i], "; ")
#}

#test <- lapply(ssres$t_gn_sym[1], stringr::str_split("; "))
#test <- lapply(cystic_overlap_drugs$t_gn_sym[1], stringr::str_split("; "))

#fun <- function(x) {
 #  stringr::str_split(x$t_gn_sym[1], "; ")
#}

#lapply(cystic_overlap_drugs, fun)

#test <- target_enrich(cystic_overlap_drugs)
#test <- stringr::str_split(cystic_overlap_drugs$t_gn_sym[1], "; ") 
#test <- gost(cystic_overlap_drugs)

```





### PKD Clinical Trial Comparison  
Pulled PKD clinical trial data from [clinicaltrials.gov](https://clinicaltrials.gov/ct2/results?cond=Polycystic+Kidney%2C+Autosomal+Dominant&Search=Apply&age_v=&gndr=&type=Intr&rslt=) to compare to signatureSearch results from each data set
```{r}
pkd_ct <- read.csv(here("data", "pkd_clinicaltrials.csv"))

#pkd_ct_in39 <- dplyr::filter(pkd_ct, Interventions %in% "metformin")
test <- agrep(pkd_ct$Interventions, gess_kidneycells_39$pert,  ignore.case= TRUE, value = TRUE)
```

no results for any 
```{r}
ct_check <- function(drug_list){
  return_list <- c()
  for (i in 1:length(drug_list)){
    test <- agrep( drug_list[i], pkd_ct$Interventions, ignore.case= TRUE, value = TRUE)
    #if (length(test)>0 ){
     # return_list[i] <- TRUE
    #}else{
     # return_list[i] <- FALSE
    #}

  }
  #names(return_list)<- drug_list
  return(test)
}

test <- ct_check(gess_kidneycells_39$pert)

test <- ct_check(gess_kidneycells_56$pert)

test <- ct_check(gess_kidneycells_19$pert)
```

### Drug Annotations  

#### Repurposing Hub
LINCS [Drug Repurposing Hub](https://www.nature.com/articles/nm.4306), contains drug names, MOAs, original indications, and targets
```{r}
repurpHub <- read.delim(here("data", "Repurposing_Hub_export.txt"))

rHub_19 <- dplyr::inner_join(gess_kidneycells_19, repurpHub, by= c("pert" = "Name"))

rHub_56 <- dplyr::inner_join(gess_kidneycells_56, repurpHub, by= c("pert" = "Name"))

rHub_39 <- dplyr::inner_join(gess_kidneycells_39, repurpHub, by= c("pert" = "Name"))
```

P70/'39 Already-Launched Drugs
```{r}
rhub_launched_39 <- dplyr::filter(rHub_39, Phase == "Launched")

```

```{r}
write.csv(rhub_launched_39, file = here("res", "sigsearch_outputs", "rhub_launcheddrugs_39.csv"))
```

Alluvial plot of drugs-targets with just launched drugs
```{r}
rhub_launched_39_top30 <- dplyr::slice_min(rhub_launched_39, order_by = Tau, n = 30)

rhub_launched_39_top_septarget <- tidyr::separate_rows(rhub_launched_39_top30, Target, sep = ", ")
#remove drugs with empty 'target' field
rhub_launched_39_top_septarget <- dplyr::filter(rhub_launched_39_top_septarget, Target != "")
```

plot
```{r}
target_alluvial <- ggplot(data = rhub_launched_39_top_septarget,
       aes(axis1 = pert, axis2 = Target)) +
  geom_alluvium(color = "black", aes(fill = WTCS)) + # , colour = trend)) + 
  geom_stratum(width = 3/12, color = "black") + #the border of the stratum
  scale_x_discrete(expand = c(.07, .07)) + 
  scale_y_discrete(expand = c(.007, .007)) + 
  scale_fill_viridis_c(aesthetics = c("colour", "fill")) +
  geom_text(stat = "stratum", size = 3.5, fontface = "bold", aes(label = after_stat(stratum))) +
  labs(title = "Targets of Top 20 Launched Drugs") +
  theme_void() 


target_alluvial
```


MOA's separated, string wrap labels
```{r}
rhub_launched_39_top_moasep <- tidyr::separate_rows(rhub_launched_39_top30, MOA, sep = ",")

rhub_launched_39_top_moasep$MOA <- stringr::str_wrap(rhub_launched_39_top_moasep$MOA, width = 20)

rhub_launched_39_top_moasep$Disease.Area <- stringr::str_wrap(rhub_launched_39_top_moasep$Disease.Area, width = 30)
```

plot
```{r}
moa_alluvial <- ggplot(data = rhub_launched_39_top_moasep,
       aes(axis1 = pert, axis2 = MOA)) +
  geom_alluvium(color = "black", aes(fill = WTCS)) + # , colour = trend)) + 
  geom_stratum(width = 3/12, color = "black") + #the border of the stratum
  scale_x_discrete(expand = c(.07, .07)) + 
  scale_y_discrete(expand = c(.007, .007)) + 
  scale_fill_viridis_c(aesthetics = c("colour", "fill")) +
  geom_text(stat = "stratum", size = 3.5, fontface = "bold", aes(label = after_stat(stratum))) +
  labs(title = "MOA of Top 30 Launched Drugs") +
  theme_void() 


moa_alluvial
```

```{r }
ggsave(here("res", "sigsearch_outputs", "moa_alluvial_wtcs_220819.pdf"), moa_alluvial, width = 10, height = 15)

```


P70/'39 Already-Launched Drugs
```{r}
rhub_launched_39 <- dplyr::filter(rHub_39, Phase == "Launched")

```


Combined repurposing hub annotated dataset drugs
```{r}
rHub_19_and_56 <-  merge(rHub_19, rHub_56, by = "pert")

rHub_all_inters <- merge(rHub_19_and_56, rHub_39,  by = "pert")
```


Save
```{r }
write.csv(rHub_19, file = here("res", "sigsearch_outputs", "ssresults_rHub_19.csv"))

write.csv(rHub_56, file = here("res", "sigsearch_outputs", "ssresults_rHub_56.csv"))

write.csv(rHub_39, file = here("res", "sigsearch_outputs", "ssresults_rHub_39.csv"))

write.csv(rHub_19_and_56, file = here("res", "sigsearch_outputs", "ssresults_rHub_19_and_56.csv"))

write.csv(rHub_all_inters, file = here("res", "sigsearch_outputs", "ssresults_rHub_all_inters.csv"))
```

"Launched" drugs futher compared for current FDA status as of 220816 FDA@Drugs data release. Manual comparison due to variabilities in names
```{r}
#fda_approved_rhub39 <- c("loperamide","etoposide","irinotecan","methylene-blue","ixazomib",

```


#### Side effects  
Data from [onSides](https://github.com/tatonetti-lab/onsides)  
__adverse_reactions_bylabel__ - All extracted adverse reactions from the ADVERSE REACTIONS section of all labels. Each drug will have multiple labels over its lifetime (revisions, generic alternatives, etc.). This table contains the results of extracting adverse reactions from every label available for download from DailyMed. 2,764,338 rows.  
__label_map__ - Map between the xml_id (xml filename), zip_id (zip filename), and set_id (drug identifier). 45,989 rows.  

```{r}
reactions <- read.csv(here("data", "onsides_v01", "adverse_reactions.csv"))
reactions_unique <- unique(reactions$concept_name)

warnings <- read.csv(here("data", "onsides_v01", "boxed_warnings.csv"))

labels <- read.csv(here("data", "onsides_v01", "latest_labels_bydrug.csv"))
```

Looking at reactions for 'launched' drugs from P70/'39 results
```{r}
onsides_39 <- dplyr::left_join(rhub_launched_39, labels, by = c("pert" = "ingredients"))

onsides_39 <- dplyr::left_join(onsides_39, reactions, by = c("latest_xml_id" = "xml_id"))

```


```{r}
write.csv(onsides_39, file = here("res", "sigsearch_outputs", "adr_onsides_precystic_drugcandidates"))
 
```



#### FDA approved drugs  
Code adapted from Jen Fisher  
Data: Drugs@FDA database was downloaded in August 2022 from https://www.fda.gov/drugs/drug-approvals-and-databases/drugsfda-data-files (Accessed date: August 2022). From the information about drugs (i.e, marketing status, application information, etc.), we created a table with information including the method of drug delivery, dosage, active ingredients, and FDA approval (FDA_products_status_220816.csv)
FDA terminology https://www.fda.gov/drugs/drug-approvals-and-databases/drugsfda-glossary-terms#:~:text=Tentative%20Approval&text=FDA%20delays%20final%20approval%20of,market%20the%20generic%20drug%20product. Drugs were filtered for unique names, regardless of form (i.e. injectible, solution, tablet, etc) and further filtered for Marketing Statuses that were not Discontinued (leaving Prescription, Over-the-counter, and Tentative Approval, due to patents)
```{r}
fda_marketing_status <- read.delim(here("data/fda_data", "MarketingStatus.txt"))
frda_product_info <- read.delim(here("data/fda_data","Products.txt"))

fda_marketing_status$ID<- paste(fda_marketing_status$ApplNo, fda_marketing_status$ProductNo, sep= "_")

frda_product_info$ID<- paste(frda_product_info$ApplNo, frda_product_info$ProductNo, sep= "_")
```

Add marketing status description to marketing status data
```{r}
marketing_lookup <- read.delim(here("data/fda_data", "MarketingStatus_Lookup.txt"))
fda_marketing_status <- merge(fda_marketing_status, marketing_lookup, by = "MarketingStatusID")
```

Combine drug info and status
```{r}
fda_data <- merge(frda_product_info, fda_marketing_status, by = "ID")
```

```{r}
write.csv(fda_data, file = here("data", "FDA_products_status_220816.csv"))
```

```{r}
fda_data <- read.csv(here("data", "FDA_products_status_220816.csv"), row.names = 1)

```

```{r}
#only unique drugs, regardless of concentration or form
fda_approved <- dplyr::filter(fda_data, MarketingStatusDescription != "Discontinued")
fda_approved <- dplyr::distinct(fda_approved, ActiveIngredient, .keep_all = TRUE)
```

```{r}
write.csv(fda_approved, file = here("data", "FDA_approved_unique_ingredients.csv"))
```

Jen's function for checking FDA approval
```{r}
FDA_APPROVAL_CHECK<- function(drug_list, fda_approved){
  #input 
  #drug_list- a vector of drugs 
  
  #output
  #return_list - a vector of true or false of drug list being FDA-approved 
  return_list <- c()
  for (i in 1:length(drug_list)){
    test <- grep( drug_list[i], fda_approved$ActiveIngredient, ignore.case= TRUE)
    if (length(test)>0 ){
      return_list[i] <- TRUE
    }else{
      return_list[i] <- FALSE
    }
    #more than 4 character are needed for matching
    if (nchar(drug_list[i])< 4){
      return_list[i] <- FALSE
    }
  }
  names(return_list)<- drug_list
  return(return_list)
}




#This function is check the FDA-approval of candidates. The approved list comes from Drugs@FDA
FDA_APPROVAL_CHECK<- function(drug_list, fda_approved){
  return_list <- c()
  for (i in 1:length(drug_list)){
    test <- agrep( drug_list[i], fda_approved$ActiveIngredient, ignore.case= TRUE, max.distance = 0.1)
    if (length(test)>0 ){
      return_list[i] <- TRUE
    }else{
      return_list[i] <- FALSE
    }

  }
  names(return_list)<- drug_list
  return(return_list)
}
```

Repurposing hub 'launched' drugs
```{r}
rhub_launched_39 <- read.csv(here("res", "sigsearch_outputs", "rhub_launcheddrugs_39.csv"), row.names = 1)
fda_approved <- read.csv(here("data", "FDA_approved_unique_ingredients.csv"), row.names = 1)
```

Test for FDA approval
```{r}
fda_approved_39 <- FDA_APPROVAL_CHECK(rhub_launched_39$pert, fda_approved)
fda_approved_39 <- mutate(rhub_launched_39, fda_approval = fda_approved_39)
fda_approved_39 <- dplyr::filter(fda_approved_39, fda_approval == TRUE)
#results for both kidney cell lines for some drugs
fda_approved_39 <- dplyr::distinct(fda_approved_39, pert, .keep_all = TRUE)
```

Compare false pos to using agrep
```{r}
#test <- fda_approved_39 #101 drugs for grep, 144 agrep
#onlyinagrep <- dplyr::setdiff(fda_approved_39, test)
```

MOA's separated, string wrap labels
```{r}
fda_approved_39_moa <- tidyr::separate_rows(fda_approved_39, MOA, sep = ",")

fda_approved_39_moa$MOA <- stringr::str_wrap(fda_approved_39_moa$MOA, width = 80)
#fda_approved_39_moa$MOA <- stringr::str_trunc(fda_approved_39_moa$MOA, width = 80)


#rhub_launched_39_top_moasep$Disease.Area <- stringr::str_wrap(rhub_launched_39_top_moasep$Disease.Area, width = 30)
fda_approved_39_moa_top <- dplyr::slice_min(fda_approved_39_moa, order_by = WTCS, n = 42)
```

#####MOA plot
```{r}
moa_alluvial <- ggplot(fda_approved_39_moa_top,
       aes(axis1 = pert, axis2 = MOA)) +
  geom_alluvium(color = "black", aes(fill = WTCS)) + # , colour = trend)) + 
  geom_stratum(width = 5/16, color = "black") + #the border of the stratum
  scale_y_discrete(limits = ) + 
  scale_fill_viridis_c(aesthetics = c("colour", "fill"), direction = -1) +
  geom_text(stat = "stratum", size = 3.25, fontface = "bold", aes(label = after_stat(stratum))) +
  labs(title = "MOA of Top FDA-Approved Drugs") +
  theme_void() 


moa_alluvial
```


```{r}

ggsave(here("res", "sigsearch_outputs", "moa_fda_alluvial.png"), moa_alluvial, width = 12, height = 6, dpi = 600)

```

Frequency of MOA's
```{r}
moa_freq <- as.data.frame(table(fda_approved_39_moa$MOA))
moa_freq <- dplyr::filter(moa_freq, Freq > 2)

moa_freq$Var1 <- str_wrap(moa_freq$Var1, width = 20)
```

```{r}
#visualize
moa_frq <- ggplot(moa_freq, aes(x = Var1, y = Freq, fill = Freq)) +  
  geom_bar(stat = "identity") + 
  scale_fill_viridis_c(aesthetics = c("colour", "fill")) +
  theme(axis.text.x = element_text(size = 10, angle = 50, vjust = 0.97, hjust=0.95), axis.title.x = element_blank(), plot.title = element_text(hjust = 0.5)) + ggtitle(label = "Most Frequent Mechanisms of Action") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
  

moa_frq
```


```{r}
ggsave(filename = here("res/sigsearch_outputs", "p70_fdaapproved_moa_freq.pdf"), moa_frq, height = 6, width = 8)

```

Frequency of original disease area indications
```{r}
indication_freq <- as.data.frame(table(fda_approved_39_moa$Disease.Area))
indication_freq <- dplyr::filter(indication_freq, Freq > 2)
```
plot
```{r}
#visualize
indication_plot <- ggplot(indication_freq, aes(x = Var1, y = Freq, fill = Freq)) +  
  geom_bar(stat = "identity") + 
  scale_fill_viridis_c(aesthetics = c("colour", "fill")) +
   theme(axis.text.x = element_text(angle = 50, vjust = 0.90, hjust=0.80), axis.title.x = element_blank(), plot.title = element_text(hjust = 0.5)) + ggtitle(label = "Most Frequent Disease Area Indications") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))

moa_frq <- ggplot(moa_freq, aes(x = Var1, y = Freq, fill = Freq)) +  
  geom_bar(stat = "identity") + 
  scale_fill_viridis_c(aesthetics = c("colour", "fill")) +
  theme(axis.text.x = element_text(angle = 50, vjust = 0.97, hjust=0.95), axis.title.x = element_blank(), plot.title = element_text(hjust = 0.5)) + ggtitle(label = "Most Frequent Mechanisms of Action") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))
  


indication_plot
```

```{r}
ggsave(filename =
         here("res/sigsearch_outputs", "p70_fdaapproved_origindication_freq.pdf"), indication_plot, height = 6, width = 8)

```

### Targets of Candidate Drugs
Targets of all FDA-approved drugs
```{r}
fda_approved_39_targets <- tidyr::separate_rows(fda_approved_39, t_gn_sym, sep = "; ")
#remove drugs with empty 'target' field
fda_approved_39_targets <- dplyr::filter(fda_approved_39_targets, t_gn_sym != "")

```

Save
```{r }
#target-separated, rhub-annotated drug results for 39
#gene_drug_targets <- rhub_launched_39_top_septarget

write.csv(fda_approved_39_targets, file = here("res", "sigsearch_outputs", "fda_drug_targets_39.csv"))
```


Alluvial plot of drugs-targets with just FDA approved drugs
```{r}
cystic_targets <- read.csv(file = here("res/sigsearch_outputs", "drug_targets_oe_cysticdegs.csv"), row.names = 1)
#target_alluvial <- tidyr::separate_rows(cystic_overlap_drugs, t_gn_sym, sep = "; ")
#target_tbl <- cbind(pert = cystic_targets$pert, Upregulated_Target = cystic_targets$t_gn_sym.x) %>% as.data.frame()
```

plot
```{r}
target_alluvial <- ggplot(data = cystic_targets,
       aes(axis1 = Drug, axis2 = Drug_Targets)) +
  geom_alluvium(color = "black", aes(fill = Drug_Targets), show.legend=FALSE) + # , colour = trend)) + 
  geom_stratum(width = 3/12, color = "black") + #the border of the stratum
  scale_x_discrete(expand = c(.07, .07)) + 
  scale_y_discrete(expand = c(.007, .007)) + 
  scale_fill_viridis_d(aesthetics = c("colour", "fill")) +
  geom_text(stat = "stratum", size = 3, fontface = "bold", aes(label = after_stat(stratum))) +
  labs(title = "Drug Targets in P21 and P28 Cystic DEGs") +
  theme_void() 


target_alluvial
```


```{r}
ggsave(here("res/sigsearch_outputs", "targets_cysticupregulated_alluvial.pdf"), target_alluvial, width = 7.5, height = 9)

```


Drug data for drugs whose targets are upregulated in both cystic data sets, pull repurposing hub data again, for manuscript
```{r}
cystic_overlap_drugs <- dplyr::filter(fda_approved_39, pert %in% unique(cystic_targets$Drug))

cystic_overlap_drugs <- cbind(Drug = cystic_overlap_drugs$pert, Drug_Targets = cystic_overlap_drugs$t_gn_sym, MOA = cystic_overlap_drugs$MOA, Original_Indication = cystic_overlap_drugs$Indication) %>% as.data.frame()
```

```{r}
write.csv(cystic_overlap_drugs, file = here("res/sigsearch_outputs", "drug_summaries_oe_cystic.csv"))
```

LINCS data for drugs with target cystic overlap
```{r}
fluoxetine_sig <- getDEGSig(cmp = "fluoxetine", cell = "HA1E", Nup = 50, Ndown = 50,  padj = 0.05, refdb = lincs)

#function used forenrichment
fluox_fea <- enrich(drug_sigs$upset, drug_sigs$downset, topreturned = 30)

```

```{r}
bubbleplot(fluox_fea$topcompared)

```

```{r}
pravastatin_sig <- getDEGSig(cmp = "pravastatin", cell = "HA1E", Nup = 300, Ndown = 300,  padj = 0.05, refdb = lincs)

#function used forenrichment
pravastatin_fea <- enrich(pravastatin_sig$upset, pravastatin_sig$downset, topreturned = 30)

```


```{r}
bubbleplot(pravastatin_fea$topcompared)+ ggtitle(label = "Pravastatin HA1E Perturbation Enrichment")

```

```{r}
fenofibrate_sig <- getDEGSig(cmp = "fenofibrate", cell = "HA1E", Nup = 200, Ndown = 200,  padj = 0.05, refdb = lincs)

#function used forenrichment
fenofibrate_fea <- enrich(fenofibrate_sig$upset, fenofibrate_sig$downset, topreturned = 20)
bubbleplot(fenofibrate_fea$topcompared) + ggtitle(label = "Fenofibrate HA1E Perturbation Enrichment")
```
bromocriptine
```{r}
bromocriptine_sig <- getDEGSig(cmp = "bromocriptine", cell = "HA1E", Nup = 200, Ndown = 200,  padj = 0.05, refdb = lincs)

#function used forenrichment
bromocriptine_fea <- enrich(bromocriptine_sig$upset, bromocriptine_sig$downset, topreturned = 20)
bubbleplot(bromocriptine_fea$topcompared) + ggtitle(label = "Bromocriptine HA1E Perturbation Enrichment")
```

Side effect data for drugs
```{r}
onsides_res <- dplyr::left_join(cystic_overlap_drugs, labels, by = c("Drug" = "ingredients"))

onsides_res <- dplyr::left_join(onsides_res, reactions, by = c("latest_xml_id" = "xml_id"))

liver_ade <- grep("liver", onsides_res$concept_name, ignore.case = TRUE)
liver_ade <- onsides_res[liver_ade,]

hepat_ade <- grep("hepat", onsides_res$concept_name, ignore.case = TRUE)
hepat_ade <- onsides_res[hepat_ade,]

renal_ade <- grep("renal", onsides_res$concept_name, ignore.case = TRUE)
renal_ade <- onsides_res[renal_ade,]

renal_liver_ade <- rbind(liver_ade, renal_ade)

prioritized_drugs <- dplyr::setdiff(cystic_overlap_drugs$Drug, renal_liver_ade$pert)
prioritized_drugs <- dplyr::filter(cystic_overlap_drugs, Drug %in% prioritized_drugs)
```

```{r}
#simple_tbl <- cbind(Drug = cystic_overlap_drugs$pert, Drug_Targets = cystic_overlap_drugs$t_gn_sym, MOA = cystic_overlap_drugs$MOA, Original_Indication = cystic_overlap_drugs$Indication)

write.csv(prioritized_drugs, file = here("res/sigsearch_outputs", "drugtarget_cysticoverlap_simpletbl.csv"))
```


```{r}
write.csv(onsides_res, file = here("res", "sigsearch_outputs", "adr_onsides_precystic_drugcandidates"))
 
```

##### Enrichment of prioritized targets, DSEA of prioritized drugs
```{r}
dsea_prioritzeddrugs <- dsea_hyperG(
  drugs = unique(cystic_targets$Drug),
  type = "GO",
  ont = "MF",
  pvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  qvalueCutoff = 0.2,
  minGSSize = 10,
  maxGSSize = 500
)


#dsea_pravastatin <- dsea_hyperG(
#  drugs = "pravastatin",
#  type = "GO",
#  ont = "MF",
#  pvalueCutoff = 0.05,
#  pAdjustMethod = "BH",
#  qvalueCutoff = 0.2,
#  minGSSize = 10,
#  maxGSSize = 500
#)
#pravastatin_plot <- dsea_barplot(dsea_pravastatin@result, "Pravastatin Target Enrichment")
#pravastatin_plot

```


```{r}
dsea_prioritzeddrugs <- dsea_prioritzeddrugs@result
write.csv(dsea_prioritzeddrugs, here("res/sigsearch_outputs", "dsea_cystictargetdrugs_pathways.csv"))
```

DSEA barplot function
```{r}
dsea_barplot <- function(dsea, titlelabel){
  dsea$Description <- stringr::str_trunc(dsea$Description, width = 75)

dseaplot <- ggplot(dplyr::slice_min(dsea, order_by = p.adjust, n = 20), aes(x=Count, y=Description, fill = p.adjust)) +
  geom_bar( stat = "identity") + 
  scale_fill_viridis_c(begin = 0.35, end = 0.95) + 
  labs(x = "Drugs Enriched for Term", y = "Functional Enrichment Terms", title = titlelabel) + 
  theme(text = element_text(size = 12), plot.title = element_text(size = 18)) + 
  theme_minimal(base_size = 14)
return(dseaplot)
}



```


```{r}
#dsea_prioritzeddrugs$Description <- stringr::str_wrap(dsea_prioritzeddrugs$Description, width = 75)
dsea_prioritzeddrugs$Description <- stringr::str_trunc(dsea_prioritzeddrugs$Description, width = 75)

dseaplot <- ggplot(dplyr::slice_min(dsea_prioritzeddrugs, order_by = p.adjust, n = 20), aes(x=Count, y=Description, fill = p.adjust)) +
  geom_bar( stat = "identity") + 
  scale_fill_viridis_c(begin = 0.35, end = 0.95) + 
  labs(x = "Drugs Enriched for Term", y = "Functional Enrichment Terms", title = "Drug Target Enrichment Analysis") + 
  theme(text = element_text(size = 12), plot.title = element_text(size = 18)) + 
  theme_minimal(base_size = 14)

dseaplot

```


```{r}
#dsea_prioritzeddrugs_bp <- dsea_prioritzeddrugs_bp$

#dsea_prioritzeddrugs_bp$Description <- stringr::str_wrap(dsea_prioritzeddrugs_bp$Description, width = 75)

#dseaplot_bp <- ggplot(dplyr::slice_min(dsea_prioritzeddrugs_bp, order_by = p.adjust, n = 20), aes(x=Count, y=Description, fill = p.adjust)) +
  #geom_point(alpha=0.7, shape = 21) +
#  geom_bar( stat = "identity") + 
#  scale_fill_viridis_c(begin = 0.35, end = 0.95) + 
#  labs(x = "Drugs Enriched for Term", y = "Functional Enrichment Terms", title = "Drug Target Enrichment Analysis") + 
#  theme(text = element_text(size = 12), plot.title = element_text(size = 18)) + 
#  theme_minimal(base_size = 13) #+ labs(title = "Drug-Target Enrichment Analysis")

#dseaplot_bp

```

```{r}

ggsave(here("res/sigsearch_outputs", "dsea_cystictargetdrugs.png"), dseaplot, width = 10, height = 8)

```

##### Networks: drug-target for the terms with most drugs
oxidoreductase activity, acting on CH or CH2 groups
```{r}
dtnetplot(drugs = unique(cystic_targets$Drug), set = "GO:0033695", ont = "MF", 
          desc="oxidoreductase activity, acting on CH or CH2 groups...")

```


```{r}
dtnetplot(drugs = unique(cystic_targets$Drug), set = "GO:1901338", ont = "MF", 
          desc="catecholamine binding")

```


```{r}
dtnetplot(drugs = drugs(dsea_prioritzeddrugs), set = "GO:0099589", ont = "MF", 
          desc="serotonin receptor activity")

```


```{r}
dtnetplot(drugs = drugs(dsea_prioritzeddrugs), set = "GO:0004993", ont = "MF", 
          desc="G protein-coupled serotonin receptor activity")

```


histamine receptor activity
```{r}
dtnetplot(drugs = unique(cystic_targets$Drug), set = "GO:0004969", ont = "MF", 
          desc="histamine receptor activity")

```



calcium-dependent protein binding
```{r}
visExport

dtnetplot(drugs = unique(cystic_targets$Drug), set = "GO:0048306", ont = "MF", 
          desc="calcium-dependent protein binding")

```

Signor results for prioritized 28 drug targets
```{r}
signor_res <- read.delim(here("data", "signor_prioritizedtargets.tsv"))

```

#### Versions  
```{r}
R.Version()
```


```{r}
installed.packages()[names(sessionInfo()$otherPkgs), "Version"]
```
  
